
<!-- saved from url=(0104)file:///C:/Users/Quantum%20Liu/Pictures/porn/%E7%88%AC%E5%8F%96%E6%88%90%E4%BA%BA%E8%A7%86%E9%A2%91.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><p>======================================================================</p><p>在这个大数据时代，网络爬虫是获取数据的利器，利用爬虫技术可以做很多有趣有用的事情。本专栏将推出一系列文章通过原创实例分享爬虫开发的基础技术。</p><p>爬虫系列：<a href="https://zhuanlan.zhihu.com/p/27032773" class="internal">用爬虫抓取昆仑决所有选手信息并保存为PDF档案！（浅谈搏击运动数据分析） - 知乎专栏</a></p><p>同时，还有微信的Python接口itchat系列：</p><a href="https://zhuanlan.zhihu.com/p/25670072" class="internal">用微信控制深度学习训练：中国特色的keras插件 - 知乎专栏</a><br><p>======================================================================</p><p>在上一期，我们尝试了使用爬虫爬取搏击运动员的资料并保存为本地PDF文档，采集的数据以静态的文本和图片为主，网站结构也比较简单。</p><p>在本期，我们将尝试爬取一个视频网站，收集视频的链接及详细信息。</p><p>我们建立一个针对该网站的<b>爬虫库</b>，以面向对象的风格将网站抽象成了一个class，封装了一些方法以供更多的扩展开发使用。</p><p>通过收集这些信息，我们可以制作一个图文图文匹配、视频推荐的机器学习数据集，用于人工智能鉴黄。</p><p><b>最后，我们通过<a href="http://link.zhihu.com/?target=https%3A//github.com/littlecodersh/ItChat" class=" wrap external" target="_blank" rel="nofollow noreferrer">itchat<i class="icon-external"></i></a>库来实现一个私人微信客户端。</b></p><p><b>声明：本文以技术交流为目的，所有敏感图片已做打码处理，请根据所在地相关法律法规访问某些网页链接。源码遵守GPL3.0协议，但敬告</b><b>切勿使用在非法的商业、个人其他意图中。若使用不当，均由个人承担责任。</b></p><p>成品展示：</p><p>服务端为aws ec2实例<br><img src="./爬取成人视频_files/025931364700e8f.jpeg" mo-width="834" mo-heigth="237" query="" data-rawwidth="834" data-rawheight="237" class="origin_image zh-lightbox-thumb lazy" width="834"></p><p>收集类别下所有视频<br><img src="./爬取成人视频_files/02593136477d938.jpeg" mo-width="515" mo-heigth="688" query="" data-rawwidth="515" data-rawheight="688" class="origin_image zh-lightbox-thumb lazy" width="515"></p><h2>背景（瞎扯）</h2><p>众所周知，鉴黄师这个工作十分辛苦，要看片看到吐，甚至可能造成功能障碍。</p><p>人工智能鉴黄技术是现今热点，奈何由于任务的不可描述性，数据集难求，入门很难。所有我想到了能不能通过爬虫构筑一个数据集呢？</p><p>于是才有了这个项目（呵呵）</p><h2><b>一、PornHub简介</b></h2><p><a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/Pornhub" class=" wrap external" target="_blank" rel="nofollow noreferrer">Pornhub维基百科<i class="icon-external"></i></a> ，<a href="http://link.zhihu.com/?target=https%3A//www.pornhub.com/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Free Porn Videos &amp;amp; Sex Movies<i class="icon-external"></i></a></p><blockquote><b>Pornhub</b>是一个加拿大的<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E8%2589%25B2%25E6%2583%2585" class=" wrap external" target="_blank" rel="nofollow noreferrer">色情<i class="icon-external"></i></a>影片分享网站。它是目前网上最大的色情影片网站，服务分享遍及全球。<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/Pornhub%23cite_note-theinquirer1-2" class=" wrap external" target="_blank" rel="nofollow noreferrer">[2]<i class="icon-external"></i></a> Pornhub于2007年在<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E9%25AD%2581%25E5%258C%2597%25E5%2585%258B" class=" wrap external" target="_blank" rel="nofollow noreferrer">魁北克<i class="icon-external"></i></a>省<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E8%2592%2599%25E7%2589%25B9%25E5%2588%25A9%25E5%25B0%2594" class=" wrap external" target="_blank" rel="nofollow noreferrer">蒙特利尔<i class="icon-external"></i></a>市成立。它是一个免费的，由广告支持的网站。除了专业色情内容，网站也提供业余色情内容。Pornhub在<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E8%258B%25B1%25E5%259B%25BD" class=" wrap external" target="_blank" rel="nofollow noreferrer">英国<i class="icon-external"></i></a><a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E4%25BC%25A6%25E6%2595%25A6" class=" wrap external" target="_blank" rel="nofollow noreferrer">伦敦<i class="icon-external"></i></a>市，<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E7%25BE%258E%25E5%259B%25BD" class=" wrap external" target="_blank" rel="nofollow noreferrer">美国<i class="icon-external"></i></a><a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E5%258A%25A0%25E5%2588%25A9%25E7%25A6%258F%25E5%25B0%25BC%25E4%25BA%259A" class=" wrap external" target="_blank" rel="nofollow noreferrer">加利福尼亚<i class="icon-external"></i></a>州<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E6%2597%25A7%25E9%2587%2591%25E5%25B1%25B1" class=" wrap external" target="_blank" rel="nofollow noreferrer">旧金山<i class="icon-external"></i></a>市，美国<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E5%25BE%2597%25E5%2585%258B%25E8%2590%25A8%25E6%2596%25AF" class=" wrap external" target="_blank" rel="nofollow noreferrer">得克萨斯<i class="icon-external"></i></a>州<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E4%25BC%2591%25E6%2596%25AF%25E6%2595%25A6" class=" wrap external" target="_blank" rel="nofollow noreferrer">休斯敦<i class="icon-external"></i></a>市以及美国<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E8%25B7%25AF%25E6%2598%2593%25E6%2596%25AF%25E5%25AE%2589%25E9%2582%25A3" class=" wrap external" target="_blank" rel="nofollow noreferrer">路易斯安那<i class="icon-external"></i></a>州<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E6%2596%25B0%25E5%25A5%25A5%25E5%25B0%2594%25E8%2589%25AF" class=" wrap external" target="_blank" rel="nofollow noreferrer">新奥尔良<i class="icon-external"></i></a>市均有分部和服务器。 2010年3月Pornhub被MindGeek购买，MindGeek同时拥有许多其他的色情网站。<a href="http://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/Pornhub%23cite_note-Buse-3" class=" wrap external" target="_blank" rel="nofollow noreferrer">[3]<i class="icon-external"></i></a></blockquote><img src="./爬取成人视频_files/02593136480fc91.jpeg" mo-width="982" mo-heigth="864" query="" data-rawwidth="200" data-rawheight="74" class="content_image lazy" width="200" data-actualsrc="https://pic2.zhimg.com/v2-7a213f32483825cd4175abbfce687885_b.png"><h2><b>二、网站结构分析</b></h2><p>在一个视频网站浏览视频，最主要的依据一般是类别。</p><p>在pornhub主页下，我们发现了所有类别的索引网页<a href="http://link.zhihu.com/?target=https%3A//www.pornhub.com/categories" class=" wrap external" target="_blank" rel="nofollow noreferrer">Categories<i class="icon-external"></i></a>。进入这个网页，所有类别都由一个封面图片和类别（category）名称表示。</p><p>（严严实实的打码）<img src="./爬取成人视频_files/categories.PNG" mo-width="0" mo-heigth="0" query="" data-rawwidth="982" data-rawheight="864" class="origin_image zh-lightbox-thumb lazy" width="982"></p><p>每个类别的链接后本类别的所有视频的摘要列表页。</p><p><img src="./爬取成人视频_files/025931364901910.jpeg" mo-width="838" mo-heigth="707" query="" data-rawwidth="838" data-rawheight="707" class="origin_image zh-lightbox-thumb lazy" width="838">每一个视频摘要则是视频详情页的入口，视频详情页可以播放视频，有视频的时长、评分等信息，正是我们想采集的主要对象。</p><p><img src="./爬取成人视频_files/0259313649e8f12.jpeg" mo-width="513" mo-heigth="522" query="" data-rawwidth="513" data-rawheight="522" class="origin_image zh-lightbox-thumb lazy" width="513">于是，我们得到了大致的网站结构<img src="./爬取成人视频_files/025931364a510a5.jpeg" mo-width="1006" mo-heigth="667" query="" data-rawwidth="1006" data-rawheight="667" class="origin_image zh-lightbox-thumb lazy" width="1006"></p><h2><b>三、分析元素正则表达式</b></h2><p>网络爬虫的核心技术就是正则表达式，这一步骤也是爬虫技术的难点与重点。</p><p>我们根据网站结构，先进入类别列表页面。</p><p>在其中一个类别上使用“审查元素”查看源码：</p><p><img src="./爬取成人视频_files/025931364b0bebd.jpeg" mo-width="979" mo-heigth="691" query="" data-rawwidth="979" data-rawheight="691" class="origin_image zh-lightbox-thumb lazy" width="979">可以，每个类别以&amp;lt;div class="category-wrapper"&amp;gt;开头。每个类别的入口链接和类别名称分别在第二第三红线处。还有一个数字（第四条红线）是本类别下有多少视频（并不准）。</p><p>于是我们可以得到每个类别的入口链接、名称以及视频数量信息的正则表达式。</p><div class="highlight"><pre><code class="language-text"><span></span>r_class=r'&amp;lt;div class="category-wrapper"&amp;gt;\n\t\t\t\t\t\t&amp;lt;a href=".*?" alt="(.*?)" class="js-mxp"'
r_url=r'&amp;lt;div class="category-wrapper"&amp;gt;\n\t\t\t\t\t\t&amp;lt;a href="(.*?)" alt=".*?" class="js-mxp"'
r_num=r'&amp;lt;span&amp;gt;.&amp;lt;var&amp;gt;(\d*?)&amp;lt;/var&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;/a&amp;gt;'
</code></pre></div>接下来我们进入某一类别的视频列表，发现是有分页机制的，也就是说我们需要知道最大页数才能遍历使用视频。<img src="./爬取成人视频_files/025931364b9cd69.jpeg" mo-width="500" mo-heigth="221" query="" data-rawwidth="500" data-rawheight="221" class="origin_image zh-lightbox-thumb lazy" width="500"><p>经过研究，我们并没有发现网页有显性给出最大页数。而且翻页是有“跳步”的，在页数很大以后翻页按钮间页数间隔也会变大。</p><p>所以我们想用倒序的方法，先得到最大页数的正则，从一个估计的最大页数上限递减页数访问，匹配返回的文本有没有翻页按钮，若有即为最大页数，若无则continue，以此得到最大页数。<img src="./爬取成人视频_files/025931364c2eaaf.jpeg" mo-width="1516" mo-heigth="709" query="" data-rawwidth="1516" data-rawheight="709" class="origin_image zh-lightbox-thumb lazy" width="1516"></p><p>我们通过之前得到的本类别总视频数和每个页面视频数来估算页数上限，这一部分代码如下：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">def</span> <span class="nf">max_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
        <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_video</span><span class="o">/</span><span class="mi">44</span><span class="p">)</span>
        <span class="n">r_max</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="page_smoothing.*?&amp;lt;a class="greyButton" href=".*?"&amp;gt;(.*?)&amp;lt;/a&amp;gt;&amp;lt;/li&amp;gt;[\s\t\n]*?&amp;lt;li class="page_next'</span>
        <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">or</span> <span class="n">t</span><span class="o">&amp;gt;</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">page</span><span class="o">-=</span><span class="mi">50</span>
            <span class="n">page</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'page'</span><span class="p">:(</span><span class="n">page</span><span class="p">)}</span>
            <span class="n">html_text</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">result</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_max</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
            <span class="n">t</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">page</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">or</span> <span class="n">t</span><span class="o">&amp;gt;</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'page'</span><span class="p">:(</span><span class="n">page</span><span class="p">)}</span>
                <span class="n">html_text</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                <span class="n">result</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_max</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
                <span class="n">page</span><span class="o">+=</span><span class="mi">15</span>
                <span class="n">t</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">max_page</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'The max page of category '</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">' is :'</span><span class="p">,</span><span class="n">max_page</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConnectionError</span><span class="p">:</span>
        <span class="n">max_page</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Got connection error, return 1 for default.'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">max_page</span>
</code></pre></div><p>接下来我们分析每个视频摘要的元素，发现除了我们要的本类别视频，还有一些在浏览器隐藏但是会体现在源码里的推荐视频，正则和目标视频基本一致，于是我们首先要进行过滤。</p><p>可以看到，正文视频都被包裹在&amp;lt;ul class="nf-videos videos search-video-thumbs"&amp;gt;这样一个类似于block的结构里面。所以我们要截取HTML文本。</p><p><img src="./爬取成人视频_files/025931364cb3de8.jpeg" mo-width="1466" mo-heigth="609" query="" data-rawwidth="1466" data-rawheight="609" class="origin_image zh-lightbox-thumb lazy" width="1466">得到视频摘要元素入口URL、标题、.jpg封面地址的正则。</p><img src="./爬取成人视频_files/025931364e878ed.jpeg" mo-width="1718" mo-heigth="685" query="" data-rawwidth="1718" data-rawheight="685" class="origin_image zh-lightbox-thumb lazy" width="1718"><div class="highlight"><pre><code class="language-python"><span></span><span class="n">r_u</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="videoblock videoBox[\s\S]*?\t&amp;lt;a href="(.*?)" title=".*?" class="img"'</span>
<span class="n">r_t</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="videoblock videoBox[\s\S]*?\t&amp;lt;a href=".*?" title="(.*?)" class="img"'</span>
<span class="n">r_c</span><span class="o">=</span><span class="s1">r'\tdata-mediumthumb="(.*?)"\n'</span>
</code></pre></div><p>我们将根据所在类别分页的URL作为参数，把抓取本页面摘要视频元素的过程写成一个函数。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">def</span> <span class="nf">get_videoadd</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">category_id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1">#从视频列表网页抓取视频名称、封面和播放页的地址</span>
    <span class="c1">#Getting name,cover,and the url of play page of the video from a list page.</span>
    <span class="n">r_u</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="videoblock videoBox[\s\S]*?\t&amp;lt;a href="(.*?)" title=".*?" class="img"'</span>
    <span class="n">r_t</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="videoblock videoBox[\s\S]*?\t&amp;lt;a href=".*?" title="(.*?)" class="img"'</span>
    <span class="n">r_c</span><span class="o">=</span><span class="s1">r'\tdata-mediumthumb="(.*?)"\n'</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
    <span class="n">t</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'page'</span><span class="p">:</span><span class="n">page</span><span class="p">},</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">t_body</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'&amp;lt;ul class="nf-videos videos search-video-thumbs"&amp;gt;'</span><span class="p">):]</span>
    <span class="n">t_l</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_t</span><span class="p">,</span><span class="n">t_body</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">title</span><span class="p">,</span><span class="n">add</span><span class="p">,</span><span class="n">cover</span><span class="p">,</span><span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">category_id</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span> <span class="k">for</span> <span class="n">title</span><span class="p">,</span><span class="n">add</span><span class="p">,</span><span class="n">cover</span><span class="p">,</span><span class="n">ID</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t_l</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_u</span><span class="p">,</span><span class="n">t_body</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_c</span><span class="p">,</span><span class="n">t_body</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_l</span><span class="p">)))]</span>
</code></pre></div>这样，我们就得到了每个视频的摘要信息。<p>接下来我们进入视频详情页。</p><p>一个视频对象最核心的内容当然是视频文件本身啦！所以我们先使用“搜索”功能搜索‘.mp4’。我们看到，pornhub的视频播放是可以选择质量的，而每个质量的视频的链接都已经给出。</p><img src="./爬取成人视频_files/025931364f6b270.jpeg" mo-width="1396" mo-heigth="600" query="" data-rawwidth="1396" data-rawheight="600" class="origin_image zh-lightbox-thumb lazy" width="1396"><p>回想一下平时浏览视频的重要指标：评分、浏览数、时长.....我们还需要这些信息。</p><p><img src="./爬取成人视频_files/025931365168328.jpeg" mo-width="685" mo-heigth="693" query="" data-rawwidth="685" data-rawheight="693" class="origin_image zh-lightbox-thumb lazy" width="685">根据以上，编写获取MP4文件链接和其他信息的函数：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">def</span> <span class="nf">get_video</span><span class="p">(</span><span class="n">videopage</span><span class="p">):</span>
    <span class="c1">#从播放页抓取视频详情，返回一个图片来了包括不同质量的MP4文件地址的一个字典，时长(秒)，一个包含浏览数、赞/踩比率和数量以及所属分类的字典。可单独使用。</span>
    <span class="c1">#Crawling detail of the video, return a tuple which has a dict of MP4 file's address of different qualities, the duration(second),a dict contains number of views, the rate and number of votes Up/Down.</span>
    
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
    <span class="n">r_v</span><span class="o">=</span><span class="s1">r'"quality":".*?","videoUrl":"(.*?)"}'</span>
    <span class="n">r_quality</span><span class="o">=</span><span class="s1">r'quality":"(\d*?)","videoUrl":".*?"}'</span>
    <span class="n">r_duration</span><span class="o">=</span><span class="s1">r'"video_duration":"(\d.*?)"'</span>
    <span class="n">r_view</span><span class="o">=</span><span class="s1">r'&amp;lt;div class="views"&amp;gt;&amp;lt;span class="count"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_percent</span><span class="o">=</span><span class="s1">r'&amp;lt;span class="percent"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_up</span><span class="o">=</span><span class="s1">r'&amp;lt;span class="votesUp"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_down</span><span class="o">=</span><span class="s1">r'&amp;lt;span class="votesDown"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_cate</span><span class="o">=</span><span class="s1">r'&amp;lt;a href="/video.*?" onclick="ga.*?;"&amp;gt;(.*?)&amp;lt;/a&amp;gt;'</span>
    <span class="n">html_text</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'https://www.pornhub.com'</span><span class="o">+</span><span class="n">videopage</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">l_v</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\\</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_v</span><span class="p">,</span><span class="n">html_text</span><span class="p">)))</span>
    <span class="n">l_q</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_quality</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
    <span class="n">add</span><span class="o">=</span><span class="p">{</span><span class="n">q</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_q</span><span class="p">,</span><span class="n">l_v</span><span class="p">)}</span>
    <span class="n">duration</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_duration</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">info</span><span class="o">=</span><span class="p">{</span><span class="s1">'views'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_view</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'percent'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_percent</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'up'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_up</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'down'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_down</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'categories'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_cate</span><span class="p">,</span><span class="n">html_text</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">add</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">info</span><span class="p">)</span>
</code></pre></div><p><b>OK，至此，网页结构分析和分析核心正则表达式的工作打印机完成，接下来我们要构建一个完整的爬虫。</b></p><h2><b>四、面向对象的网络爬虫</b></h2><p>爬虫是用来爬取网页上的“对象”的，那么我们理所当然的应该使用面向对象的风格来抽象我们的爬取行为。</p><p><img src="./爬取成人视频_files/025931364a510a5.jpeg" mo-width="1006" mo-heigth="667" query="" data-rawwidth="1006" data-rawheight="667" class="origin_image zh-lightbox-thumb lazy" width="1006">还是这张图，根据网站结构，网站可分为三级：站（site）、类别（category）、视频（video）。站里包含一系列category，每个category包含一系列的video。</p><p>所以我决定用三个类来抽象这三个级别：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">class</span> <span class="nc">site</span><span class="p">():</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">category</span><span class="p">():</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">video</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div><p>当我们使用爬虫时，先实例化一个site对象，这个对象有一系列的方法和一个category对象的列表（词典），我们在这个层次对category进行批量处理；在每个category对象里又有一系列方法和video对象，我们在这个层次批量处理video。</p><p>大家可能会注意到，之前几个函数的返回值都是tuple类型，之所以这样做是为了使用multiprocessing进行并行批处理时方便使用pool.apply_async()函数。</p><p>我尽量不使用第三方库，只使用了requests这个神库。</p><p>以下是本爬虫库的完整代码：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">Created on Mon May 22 21:56:43 2017</span>

<span class="sd">@author: Quantum Liu</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span><span class="n">cpu_count</span><span class="p">,</span><span class="n">freeze_support</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">class</span> <span class="nc">site</span><span class="p">():</span>
<span class="c1">#对于pornhub全站的抽象，拥有多个视频类别（categories）;</span>
<span class="c1">#An abstraction of pornhub website,has a list of categories and videos.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category_params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">category_name_list</span><span class="o">=</span><span class="n">list_categories</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category_dict</span><span class="o">=</span><span class="p">{}</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'There are '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">))</span><span class="o">+</span><span class="s1">' categories.</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_list</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id2title_dict</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category_id</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title2id_dict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">def</span> <span class="nf">init_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">''</span><span class="p">],</span><span class="n">num_category</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num_category</span> <span class="ow">and</span> <span class="n">name_list</span><span class="p">:</span>
            <span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">num_category</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">name_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">name_list</span> <span class="ow">and</span> <span class="n">num_category</span><span class="p">:</span>
            <span class="n">name_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category_list</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">num_category</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_list</span><span class="p">))]</span>
        <span class="n">clist</span><span class="o">=</span><span class="n">init_categories_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_params</span><span class="p">,(</span><span class="n">name_list</span> <span class="k">if</span> <span class="n">name_list</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_dict</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">c</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">iterate_videos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">category_name</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">num_page</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">start_page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">iterate_all</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_dict</span><span class="p">[</span><span class="n">category_name</span><span class="p">]</span><span class="o">.</span><span class="n">iterate_videos_p</span><span class="p">(</span><span class="n">num_page</span><span class="p">,</span><span class="n">start_page</span><span class="p">,</span><span class="n">iterate_all</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_list</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">video_id</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title2id_dict</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">title</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">video_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id2title_dict</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">video_id</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="bp">self</span>
<span class="c1">#==============================================================================</span>
<span class="c1">#     </span>
<span class="c1">#==============================================================================</span>
<span class="k">class</span> <span class="nc">category</span><span class="p">():</span>
<span class="c1">#对于视频分类(category)的抽象，拥有一系列视频</span>
<span class="c1">#An abstration of "categories", has a list of viseos</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">num_video</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">category_id</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">=</span><span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_video</span><span class="o">=</span><span class="n">num_video</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_page</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">videos</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category_id</span><span class="o">=</span><span class="n">category_id</span>
    <span class="k">def</span> <span class="nf">max_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
            <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_video</span><span class="o">/</span><span class="mi">44</span><span class="p">)</span>
            <span class="n">r_max</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="page_smoothing.*?&amp;lt;a class="greyButton" href=".*?"&amp;gt;(.*?)&amp;lt;/a&amp;gt;&amp;lt;/li&amp;gt;[\s\t\n]*?&amp;lt;li class="page_next'</span>
            <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">or</span> <span class="n">t</span><span class="o">&amp;gt;</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">page</span><span class="o">-=</span><span class="mi">50</span>
                <span class="n">page</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'page'</span><span class="p">:(</span><span class="n">page</span><span class="p">)}</span>
                <span class="n">html_text</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                <span class="n">result</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_max</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
                <span class="n">t</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">page</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">or</span> <span class="n">t</span><span class="o">&amp;gt;</span><span class="mi">10</span><span class="p">):</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'page'</span><span class="p">:(</span><span class="n">page</span><span class="p">)}</span>
                    <span class="n">html_text</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">result</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_max</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
                    <span class="n">page</span><span class="o">+=</span><span class="mi">15</span>
                    <span class="n">t</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">max_page</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'The max page of category '</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">' is :'</span><span class="p">,</span><span class="n">max_page</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConnectionError</span><span class="p">:</span>
            <span class="n">max_page</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'Got connection error, return 1 for default.'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_page</span>
    <span class="k">def</span> <span class="nf">iterate_videos_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_page</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">start_page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">iterate_all</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">start_page</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">start_page</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">freeze_support</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="n">param_results</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_page</span><span class="p">,((</span><span class="n">start_page</span><span class="o">+</span><span class="n">num_page</span> <span class="k">if</span> <span class="n">num_page</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">start_page</span><span class="o">+</span><span class="mi">100</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_page</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">iterate_all</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_page</span><span class="p">)):</span>
            <span class="n">param_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">get_videoadd</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">category_id</span><span class="p">)))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="n">video_results</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">param_results</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]:</span>
            <span class="n">video_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">video</span><span class="p">,</span><span class="n">params</span><span class="p">))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">videos</span><span class="o">+=</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">video_results</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">videos</span>
<span class="c1">#==============================================================================</span>
<span class="c1">#         </span>
<span class="c1">#==============================================================================</span>
<span class="k">class</span> <span class="nc">video</span><span class="p">():</span>
<span class="c1">#对视频的抽象，属性包括所在网页、封面、不同质量MP4文件的链接，时长，评价，所属分类</span>
<span class="c1">#An abstraction of video, attributes contain the web page, .MP4 files' urls of different qualities, duration, grade, categories</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">cover</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">video_id</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">=</span><span class="n">page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cover</span><span class="o">=</span><span class="n">cover</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="o">=</span><span class="n">video_id</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Crawling video:'</span><span class="o">+</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp4add</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">''</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp4add</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">=</span><span class="n">get_video</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp4add</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">''</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'Got error, failed instantiating viedo: '</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pic_dir</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">show_pic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
<span class="c1">#显示视频信息和封面图片</span>
<span class="c1">#Show infomations and the cover oicture of the video</span>
        <span class="k">if</span> <span class="n">show_pic</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pic_dir</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pic_dir</span><span class="o">=</span><span class="s1">'./'</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">'categories'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pic_dir</span><span class="o">=</span><span class="n">pic_dir</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pic_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pic_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pic_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pic_dir</span><span class="o">+</span><span class="s1">'/'</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">+</span><span class="s1">'.jpg'</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pic_path</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cover</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pic_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Video: ID '</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="o">+</span><span class="s1">' '</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mp4add</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
<span class="c1">#==============================================================================</span>
<span class="c1">#         </span>
<span class="c1">#==============================================================================</span>
<span class="k">def</span> <span class="nf">list_categories</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'https://www.pornhub.com'</span><span class="p">):</span>
<span class="c1">#列举Pornhub所有的视频分类，返回一个键名为类名的字典和一个属于类名的list，字典的值是tuple，包含入口URL，视频数，赋予的ID</span>
<span class="c1">#Enumerate all categories of PornHub,return a dictionary whose keys are names of categories and a list of categories names, the values of the dics is a tuple,contain entrance url, number of videos, a given ID</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
    <span class="n">cate_root</span><span class="o">=</span><span class="n">root</span><span class="o">+</span><span class="s1">'/categories'</span>
    <span class="n">r_class</span><span class="o">=</span><span class="s1">r'&amp;lt;div class="category-wrapper"&amp;gt;\n\t\t\t\t\t\t&amp;lt;a href=".*?" alt="(.*?)" class="js-mxp"'</span>
    <span class="n">r_url</span><span class="o">=</span><span class="s1">r'&amp;lt;div class="category-wrapper"&amp;gt;\n\t\t\t\t\t\t&amp;lt;a href="(.*?)" alt=".*?" class="js-mxp"'</span>
    <span class="n">r_num</span><span class="o">=</span><span class="s1">r'&amp;lt;span&amp;gt;.&amp;lt;var&amp;gt;(\d*?)&amp;lt;/var&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;/a&amp;gt;'</span>
    <span class="n">res</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cate_root</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">html_text</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">text</span>
    <span class="n">class_list</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_class</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
    <span class="n">url_list</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_url</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
    <span class="n">num_list</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_num</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
    <span class="n">category_params</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:(</span><span class="n">root</span><span class="o">+</span><span class="n">u</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">ID</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ID</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">class_list</span><span class="p">,</span><span class="n">url_list</span><span class="p">,</span><span class="n">num_list</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_list</span><span class="p">)))}</span>
    <span class="k">return</span> <span class="n">category_params</span><span class="p">,</span><span class="n">class_list</span>
<span class="k">def</span> <span class="nf">init_categories_p</span><span class="p">(</span><span class="n">category_params</span><span class="o">=</span><span class="p">{},</span><span class="n">name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">''</span><span class="p">]):</span>
    <span class="c1">#实例化category的并行实现</span>
    <span class="c1">#A parallel implemention of instantiating categories</span>
    <span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">())</span>
    <span class="n">results</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">category</span><span class="p">,(</span><span class="n">name</span><span class="p">,)</span><span class="o">+</span><span class="n">category_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">init_categories_s</span><span class="p">(</span><span class="n">category_params</span><span class="o">=</span><span class="p">{},</span><span class="n">name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">''</span><span class="p">]):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">category</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="p">,)</span><span class="o">+</span><span class="n">category_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">get_videoadd</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">category_id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1">#从视频列表网页抓取视频名称、封面和播放页的地址</span>
    <span class="c1">#Getting name,cover,and the url of play page of the video from a list page.</span>
    <span class="n">r_u</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="videoblock videoBox[\s\S]*?\t&amp;lt;a href="(.*?)" title=".*?" class="img"'</span>
    <span class="n">r_t</span><span class="o">=</span><span class="s1">r'&amp;lt;li class="videoblock videoBox[\s\S]*?\t&amp;lt;a href=".*?" title="(.*?)" class="img"'</span>
    <span class="n">r_c</span><span class="o">=</span><span class="s1">r'\tdata-mediumthumb="(.*?)"\n'</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
    <span class="n">t</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'page'</span><span class="p">:</span><span class="n">page</span><span class="p">},</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">t_body</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'&amp;lt;ul class="nf-videos videos search-video-thumbs"&amp;gt;'</span><span class="p">):]</span>
    <span class="n">t_l</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_t</span><span class="p">,</span><span class="n">t_body</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">title</span><span class="p">,</span><span class="n">add</span><span class="p">,</span><span class="n">cover</span><span class="p">,</span><span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">category_id</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span> <span class="k">for</span> <span class="n">title</span><span class="p">,</span><span class="n">add</span><span class="p">,</span><span class="n">cover</span><span class="p">,</span><span class="n">ID</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t_l</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_u</span><span class="p">,</span><span class="n">t_body</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_c</span><span class="p">,</span><span class="n">t_body</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_l</span><span class="p">)))]</span>
<span class="k">def</span> <span class="nf">get_video</span><span class="p">(</span><span class="n">videopage</span><span class="p">):</span>
    <span class="c1">#从播放页抓取视频详情，返回一个图片来了包括不同质量的MP4文件地址的一个字典，时长(秒)，一个包含浏览数、赞/踩比率和数量以及所属分类的字典。可单独使用。</span>
    <span class="c1">#Crawling detail of the video, return a tuple which has a dict of MP4 file's address of different qualities, the duration(second),a dict contains number of views, the rate and number of votes Up/Down.</span>
    
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
    <span class="n">r_v</span><span class="o">=</span><span class="s1">r'"quality":".*?","videoUrl":"(.*?)"}'</span>
    <span class="n">r_quality</span><span class="o">=</span><span class="s1">r'quality":"(\d*?)","videoUrl":".*?"}'</span>
    <span class="n">r_duration</span><span class="o">=</span><span class="s1">r'"video_duration":"(\d.*?)"'</span>
    <span class="n">r_view</span><span class="o">=</span><span class="s1">r'&amp;lt;div class="views"&amp;gt;&amp;lt;span class="count"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_percent</span><span class="o">=</span><span class="s1">r'&amp;lt;span class="percent"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_up</span><span class="o">=</span><span class="s1">r'&amp;lt;span class="votesUp"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_down</span><span class="o">=</span><span class="s1">r'&amp;lt;span class="votesDown"&amp;gt;(.*?)&amp;lt;/span&amp;gt;'</span>
    <span class="n">r_cate</span><span class="o">=</span><span class="s1">r'&amp;lt;a href="/video.*?" onclick="ga.*?;"&amp;gt;(.*?)&amp;lt;/a&amp;gt;'</span>
    <span class="n">html_text</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'https://www.pornhub.com'</span><span class="o">+</span><span class="n">videopage</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">l_v</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\\</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_v</span><span class="p">,</span><span class="n">html_text</span><span class="p">)))</span>
    <span class="n">l_q</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_quality</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span>
    <span class="n">add</span><span class="o">=</span><span class="p">{</span><span class="n">q</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_q</span><span class="p">,</span><span class="n">l_v</span><span class="p">)}</span>
    <span class="n">duration</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_duration</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">info</span><span class="o">=</span><span class="p">{</span><span class="s1">'views'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_view</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'percent'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_percent</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'up'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_up</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'down'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_down</span><span class="p">,</span><span class="n">html_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'categories'</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r_cate</span><span class="p">,</span><span class="n">html_text</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">add</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">info</span><span class="p">)</span>
</code></pre></div><h2>五、使用爬虫库（初步）</h2><p>有了爬虫库，我们当然是要用它来爬取网站内容了。</p><p>首先我们要实例化一个site对象并实例化一系列的category。</p><p>我写了一个脚本，作为一个console程序运行，根据用户输入来收集指定的类别</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">Created on Sun May 28 09:51:46 2017</span>

<span class="sd">@author: Quantum Liu</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">pornspider</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'pornhub.pkl'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pornhub</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">pornhub</span><span class="o">=</span><span class="n">site</span><span class="p">()</span>
<span class="n">st</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">n</span><span class="o">=</span><span class="mi">0</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">name_list</span><span class="o">=</span><span class="nb">input</span><span class="p">(</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n\n</span><span class="s1">Please type a list of category name from the categories list, split them by "," : '</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">name_list</span><span class="o">=</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Collecting categories: '</span><span class="o">+</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_list</span><span class="p">))</span>
<span class="n">pornhub</span><span class="o">.</span><span class="n">init_category</span><span class="p">(</span><span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Collecting category: '</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
    <span class="n">pornhub</span><span class="o">.</span><span class="n">iterate_videos</span><span class="p">(</span><span class="n">category_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">num_page</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">start_page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">iterate_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">n</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">videos</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Number of videos :'</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="s1">'Average time costing : '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">))</span><span class="o">+</span><span class="s1">'page/s'</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'pornhub.pkl'</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pornhub</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</code></pre></div><p>在ec2上运行效果：</p><p><img src="./爬取成人视频_files/02593136526f9c0.jpeg" mo-width="1902" mo-heigth="541" query="" data-rawwidth="1902" data-rawheight="541" class="origin_image zh-lightbox-thumb lazy" width="1902"><img src="./爬取成人视频_files/0259313652df678.jpeg" mo-width="1026" mo-heigth="282" query="" data-rawwidth="1026" data-rawheight="282" class="origin_image zh-lightbox-thumb lazy" width="1026">在这个程序跑完后我们就有了一个有内容的pornhub局部内容的本地映像，作为一个site对象被储存在一个.pkl文件里。</p><p>我们不妨再写一个抓取全部类别的自动脚步：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">Created on Sun May 28 09:51:46 2017</span>

<span class="sd">@author: Quantum Liu</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">pornspider</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'pornhub.pkl'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pornhub</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">pornhub</span><span class="o">=</span><span class="n">site</span><span class="p">()</span>
<span class="n">st</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">n</span><span class="o">=</span><span class="mi">0</span>
<span class="n">pornhub</span><span class="o">.</span><span class="n">init_category</span><span class="p">(</span><span class="n">name_list</span><span class="o">=</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Collecting category: '</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
    <span class="n">pornhub</span><span class="o">.</span><span class="n">iterate_videos</span><span class="p">(</span><span class="n">category_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">num_page</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">start_page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">iterate_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">n</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">videos</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Number of videos :'</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="s1">'Average time costing : '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">))</span><span class="o">+</span><span class="s1">'page/s'</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'pornhub.pkl'</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pornhub</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</code></pre></div><p>这个脚本跑完后，我们就可以得到pornhub整个网站核心内容的本地映像。</p><p>交互模式执行以下代码，来查看某一视频的详情（包括视频地址、封面、评价等）：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'pornhub.pkl'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pornhub</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">v</span><span class="o">=</span><span class="n">pornhub</span><span class="o">.</span><span class="n">video_list</span><span class="p">[</span><span class="s1">'22.127.27'</span><span class="p">]</span>
<span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="n">v</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div><p>效果：<img src="./爬取成人视频_files/02593136539b8d3.jpeg" mo-width="1466" mo-heigth="708" query="" data-rawwidth="1466" data-rawheight="708" class="origin_image zh-lightbox-thumb lazy" width="1466"></p><p>使用迅雷尝试下载整个链接<br><img src="./爬取成人视频_files/02593136546d3a5.jpeg" mo-width="698" mo-heigth="661" query="" data-rawwidth="698" data-rawheight="661" class="origin_image zh-lightbox-thumb lazy" width="698"><img src="./爬取成人视频_files/025931365507b55.jpeg" mo-width="871" mo-heigth="197" query="" data-rawwidth="871" data-rawheight="197" class="origin_image zh-lightbox-thumb lazy" width="871">可以下载而且速度非常快，接近1/2最大下载速度。ヽ(ﾟ∀ﾟ)ﾒ(ﾟ∀ﾟ)ﾉ </p><p><b>OK，至此，我们已经实现了基本的对爬虫库的使用，实现了基本的数据采集功能和视频下载功能！</b></p><h2><b>六、使用爬虫库（高级，微信客户端）</b></h2><p>遥想司机当年，辛辛苦苦的追踪一个个不停更换域名的网站，一直在梦想要是有一天动动手指就有开不完的车。。。</p><p>这个，所以，输入有了服务端的爬虫程序，但是如果能用移动设备随时随地来收集数据那岂不是方便了很多吗？（嘴角挂着和善的笑容.jpg）</p><p><a href="http://link.zhihu.com/?target=https%3A//github.com/littlecodersh/ItChat" class=" wrap external" target="_blank" rel="nofollow noreferrer">itchat<i class="icon-external"></i></a>库我也是用的多了，每次开发Python程序有使用移动设备访问的需求时都是选择它。<br></p><p>建立一个微信客户端的基本思路就是抽象化一个会话（session）类，代表微信交互，初始化时登录微信并实例化（本地加载或者重新实例化）一个site对象；注册特定指令，按照微信发送的文本消息对应到类的方法执行操作。</p><p>同时，我们需要一个独特的错误处理机制，把常用的traceback.print_exc()改为send_text(traceback.format_exc()),以实现使用微信接收报错信息。</p><p>代码：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">Created on Mon May 29 20:42:42 2017</span>

<span class="sd">@author: Quantum Liu</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">pornspider</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">itchat</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="n">pv</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="kn">from</span> <span class="nn">itchat.content</span> <span class="kn">import</span> <span class="n">TEXT</span>
<span class="k">if</span> <span class="n">pv</span><span class="o">&amp;gt;</span><span class="mi">2</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_thread</span> <span class="kn">as</span> <span class="nn">th</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">thread</span> <span class="kn">as</span> <span class="nn">th</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">ConnectionError</span>
<span class="c1">#==============================================================================</span>
<span class="c1">#==============================================================================</span>
<span class="c1"># A log in function call it at first</span>
<span class="c1">#函数，需要首先调用</span>
<span class="c1">#==============================================================================</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">'Windows'</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">():</span>
        <span class="n">itchat</span><span class="o">.</span><span class="n">auto_login</span><span class="p">(</span><span class="n">enableCmdQR</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hotReload</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="c1">#</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">itchat</span><span class="o">.</span><span class="n">auto_login</span><span class="p">(</span><span class="n">enableCmdQR</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">hotReload</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="c1">#</span>
    <span class="n">itchat</span><span class="o">.</span><span class="n">dump_login_status</span><span class="p">()</span><span class="c1">#dump</span>
<span class="c1">#==============================================================================</span>
<span class="c1"># </span>
<span class="c1">#==============================================================================</span>
<span class="k">def</span> <span class="nf">send_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c1">#send text msgs to 'filehelper'</span>
    <span class="c1">#给文件助手发送文本信息</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">itchat</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">text</span><span class="p">,</span><span class="n">toUserName</span><span class="o">=</span><span class="s1">'filehelper'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ConnectionError</span><span class="p">,</span><span class="ne">NotImplementedError</span><span class="p">,</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Conection error,failed to send the message!</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>
<span class="k">def</span> <span class="nf">send_img</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1">#send text imgs to 'filehelper'</span>
    <span class="c1">#给文件助手发送</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">itchat</span><span class="o">.</span><span class="n">send_image</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">toUserName</span><span class="o">=</span><span class="s1">'filehelper'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ConnectionError</span><span class="p">,</span><span class="ne">NotImplementedError</span><span class="p">,</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Conection error,failed to send the figure!</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>
<span class="k">class</span> <span class="nc">wechat_session</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#初始化一个微信会话，登录并加载/实例化pornhub对象</span>
        <span class="c1">#Initializing a wechat session,log in and load/instante a pornhub object</span>
        <span class="n">login</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Loged in successfully!</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">send_text</span><span class="p">(</span><span class="s1">'Loged in successfully!</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'pornhub.pkl'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">send_text</span><span class="p">(</span><span class="s1">'Failed loading local pickle file, initing pornhub object...</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">=</span><span class="n">site</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">radio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1">#电台功能，随机推送指定数目，如：电台 2</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">show_video_detail</span><span class="p">(</span><span class="n">video_id</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span><span class="n">show_pic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">video_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">video_list</span><span class="p">),</span><span class="n">n</span><span class="p">))]]</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_list</span><span class="o">=</span><span class="s1">' , '</span><span class="p">):</span>
        <span class="c1">#收集指定类别，如：收集[Russian,German]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">name_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">send_text</span><span class="p">(</span><span class="s1">'Collecting categories: '</span><span class="o">+</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">init_category</span><span class="p">(</span><span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">)</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">st</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
            <span class="n">send_text</span><span class="p">(</span><span class="s1">'Collecting category: '</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">iterate_videos</span><span class="p">(</span><span class="n">category_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">num_page</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">start_page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">iterate_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">n</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">videos</span><span class="p">)</span>
        <span class="n">send_text</span><span class="p">(</span><span class="s1">'Number of videos : '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">' Average time cost : '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">))</span><span class="o">+</span><span class="s1">'page/s'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">list_all_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="s1">'https://www.pornhub.com'</span><span class="p">):</span>
        <span class="c1">#查看全站的类别列表，发送到微信</span>
        <span class="n">send_text</span><span class="p">(</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">list_local_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#查看本地的类别列表，发送到微信</span>
        <span class="n">local_name_list</span><span class="o">=</span><span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="bp">False</span><span class="p">)]</span>
        <span class="n">send_text</span><span class="p">(</span><span class="s1">'There are '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_name_list</span><span class="p">))</span><span class="o">+</span><span class="s1">' categories.</span><span class="se">\n</span><span class="s1">'</span><span class="o">+</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_name_list</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">broswe_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1">#浏览某一类别，[]内是类别名称，{}是开始页数，（）内是跨度</span>
        <span class="n">local_name_list</span><span class="o">=</span><span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="bp">False</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">local_name_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">_end</span><span class="o">=</span><span class="n">start</span><span class="o">+</span><span class="n">num</span>
        <span class="n">msg</span><span class="o">=</span><span class="s1">'Brosweing category '</span><span class="o">+</span><span class="n">name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">show_video_abstrct</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">videos</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">_end</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">send_text</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">send_text</span><span class="p">(</span><span class="s1">'Got key error!Please check the name.'</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="k">def</span> <span class="nf">show_video_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">video_id</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">pic_dir</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">show_pic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1">#显示视频信息和封面图片</span>
    <span class="c1">#Show infomations and the cover oicture of the video</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">video</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">video_list</span><span class="p">[</span><span class="n">video_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">show_pic</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'use-agent'</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span><span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pic_dir</span><span class="p">:</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">pic_dir</span><span class="o">=</span><span class="s1">'./'</span><span class="o">+</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">'categories'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">'categories'</span><span class="p">]</span> <span class="k">else</span> <span class="s1">'Sex'</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">pic_dir</span><span class="o">=</span><span class="n">pic_dir</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">pic_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">pic_dir</span><span class="p">)</span>
                <span class="n">video</span><span class="o">.</span><span class="n">pic_path</span><span class="o">=</span><span class="n">video</span><span class="o">.</span><span class="n">pic_dir</span><span class="o">+</span><span class="s1">'/'</span><span class="o">+</span><span class="n">video</span><span class="o">.</span><span class="n">title</span><span class="o">+</span><span class="s1">'.jpg'</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">pic_path</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">cover</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">send_img</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">pic_path</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">=</span><span class="s1">'Video: ID '</span><span class="o">+</span><span class="n">video</span><span class="o">.</span><span class="n">video_id</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Title: '</span><span class="o">+</span><span class="n">video</span><span class="o">.</span><span class="n">title</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Duration: '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">video</span><span class="o">.</span><span class="n">mp4add</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">msg</span><span class="o">+=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Quaulity '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">'P: </span><span class="se">\n</span><span class="s1">'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">video</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">msg</span><span class="o">+=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">': '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">send_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">send_text</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">show_video_abstrct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">video_id</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="c1">#显示视频摘要信息</span>
    <span class="c1">#Show abstract infomations of the video</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">video</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">video_list</span><span class="p">[</span><span class="n">video_id</span><span class="p">]</span>
            <span class="n">video</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">=</span><span class="s1">'Video: ID '</span><span class="o">+</span><span class="n">video</span><span class="o">.</span><span class="n">video_id</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Title: '</span><span class="o">+</span><span class="n">video</span><span class="o">.</span><span class="n">title</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Duration: '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Quaulitys :'</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">video</span><span class="o">.</span><span class="n">mp4add</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">msg</span><span class="o">+=</span><span class="s1">' '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">'P;'</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">video</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">msg</span><span class="o">+=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">': '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">send_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">send_text</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#保存当前pornhub对象</span>
        <span class="n">send_text</span><span class="p">(</span><span class="s1">'Saving pornhun object'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'pornhub.pkl'</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">send_text</span><span class="p">(</span><span class="s1">'Failed saving pickle file !'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">GetMiddleStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">content</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">startStr</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">endStr</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="c1">#get the string between two specified strings</span>
    <span class="c1">#从指定的字符串之间截取字符串</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">startIndex</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">startStr</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">startIndex</span><span class="o">&amp;gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">startIndex</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">startStr</span><span class="p">)</span>
          <span class="n">endIndex</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endStr</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">content</span><span class="p">[</span><span class="n">startIndex</span><span class="p">:</span><span class="n">endIndex</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">''</span>
    <span class="k">def</span> <span class="nf">registe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#注册回复方法</span>
        <span class="nd">@itchat.msg_register</span><span class="p">(</span><span class="n">TEXT</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">auto_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="n">text</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">'Text'</span><span class="p">]</span>
            <span class="n">cmd</span><span class="o">=</span><span class="p">{</span><span class="s1">'raido'</span><span class="p">:[</span><span class="s1">u'电台'</span><span class="p">,</span><span class="s1">'radio'</span><span class="p">,</span><span class="s1">'Radio'</span><span class="p">],</span><span class="s1">'collect'</span><span class="p">:[</span><span class="s1">u'收集'</span><span class="p">,</span><span class="s1">'collect'</span><span class="p">,</span><span class="s1">'Collect'</span><span class="p">],</span><span class="s1">'broswe category'</span><span class="p">:[</span><span class="s1">u'浏览类别'</span><span class="p">,</span><span class="s1">'Broswe category'</span><span class="p">,</span><span class="s1">'broswe category'</span><span class="p">],</span><span class="s1">'broswe video'</span><span class="p">:[</span><span class="s1">u'浏览视频'</span><span class="p">,</span><span class="s1">'broswe video'</span><span class="p">,</span><span class="s1">'Broswe video'</span><span class="p">],</span><span class="s1">'enumerate categorise'</span><span class="p">:[</span><span class="s1">u'显示本地类别'</span><span class="p">,</span><span class="s1">'enumerate local categories'</span><span class="p">],</span><span class="s1">'enumerate all categorise'</span><span class="p">:[</span><span class="s1">u'显示所有类别'</span><span class="p">,</span><span class="s1">'enumerate all categories'</span><span class="p">],</span><span class="s1">'save'</span><span class="p">:[</span><span class="s1">'Save'</span><span class="p">,</span><span class="s1">u'保存'</span><span class="p">]}</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">'ToUserName'</span><span class="p">]</span><span class="o">==</span><span class="s1">'filehelper'</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'raido'</span><span class="p">]):</span>
                    <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">r"\d+\.?\d*"</span><span class="p">,</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">radio</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'collect'</span><span class="p">]):</span>
                    <span class="n">name_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetMiddleStr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="s1">'['</span><span class="p">,</span><span class="s1">']'</span><span class="p">)</span>
                    <span class="n">th</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collect</span><span class="p">,(</span><span class="n">name_list</span><span class="p">,))</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'broswe category'</span><span class="p">]):</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetMiddleStr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="s1">'['</span><span class="p">,</span><span class="s1">']'</span><span class="p">)</span>
                    <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pornhub</span><span class="o">.</span><span class="n">category_name_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetMiddleStr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="s1">'{'</span><span class="p">,</span><span class="s1">'}'</span><span class="p">)</span>
                    <span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="n">start</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetMiddleStr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="s1">'('</span><span class="p">,</span><span class="s1">')'</span><span class="p">)</span>
                    <span class="n">num</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="mi">5</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">broswe_category</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'broswe video'</span><span class="p">]):</span>
                    <span class="n">video_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetMiddleStr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="s1">'['</span><span class="p">,</span><span class="s1">']'</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">show_video_detail</span><span class="p">(</span><span class="n">video_id</span><span class="o">=</span><span class="n">video_id</span><span class="p">,</span><span class="n">show_pic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'enumerate categorise'</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">list_local_categories</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">send_text</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'enumerate all categorise'</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">list_all_categories</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">send_text</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'save'</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">send_text</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">itchat</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">session</span><span class="o">=</span><span class="n">wechat_session</span><span class="p">()</span>
</code></pre></div>我们预置了一系列指令的词典：<div class="highlight"><pre><code class="language-python"><span></span><span class="n">cmd</span><span class="o">=</span><span class="p">{</span><span class="s1">'raido'</span><span class="p">:[</span><span class="s1">u'电台'</span><span class="p">,</span><span class="s1">'radio'</span><span class="p">,</span><span class="s1">'Radio'</span><span class="p">],</span><span class="s1">'collect'</span><span class="p">:[</span><span class="s1">u'收集'</span><span class="p">,</span><span class="s1">'collect'</span><span class="p">,</span><span class="s1">'Collect'</span><span class="p">],</span><span class="s1">'broswe category'</span><span class="p">:[</span><span class="s1">u'浏览类别'</span><span class="p">,</span><span class="s1">'Broswe category'</span><span class="p">,</span><span class="s1">'broswe category'</span><span class="p">],</span><span class="s1">'broswe video'</span><span class="p">:[</span><span class="s1">u'浏览视频'</span><span class="p">,</span><span class="s1">'broswe video'</span><span class="p">,</span><span class="s1">'Broswe video'</span><span class="p">],</span><span class="s1">'enumerate categorise'</span><span class="p">:[</span><span class="s1">u'显示本地类别'</span><span class="p">,</span><span class="s1">'enumerate local categories'</span><span class="p">],</span><span class="s1">'enumerate all categorise'</span><span class="p">:[</span><span class="s1">u'显示所有类别'</span><span class="p">,</span><span class="s1">'enumerate all categories'</span><span class="p">],</span><span class="s1">'save'</span><span class="p">:[</span><span class="s1">'Save'</span><span class="p">,</span><span class="s1">u'保存'</span><span class="p">]}</span>
</code></pre></div><p>然后使用如下的判断语句来实现指令检测</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]):</span>
    <span class="n">foo</span><span class="p">()</span>
</code></pre></div><p>我们用[]、{}、()来指定命令的参数，这时候我们需要一个截取指定字符间字符串的函数：</p><div class="highlight"><pre><code class="language-python"><span></span>    <span class="k">def</span> <span class="nf">GetMiddleStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">content</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">startStr</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">endStr</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="c1">#get the string between two specified strings</span>
    <span class="c1">#从指定的字符串之间截取字符串</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">startIndex</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">startStr</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">startIndex</span><span class="o">&amp;gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">startIndex</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">startStr</span><span class="p">)</span>
          <span class="n">endIndex</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endStr</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">content</span><span class="p">[</span><span class="n">startIndex</span><span class="p">:</span><span class="n">endIndex</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">''</span>
</code></pre></div><p>我们在电脑上运行这个客户端</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="n">python</span> <span class="n">wechat_client</span><span class="p">.</span><span class="n">py</span>
</code></pre></div><p>然后扫码登录，登陆成功</p><img src="./爬取成人视频_files/0259313655d29f5.jpeg" mo-width="625" mo-heigth="214" query="" data-rawwidth="625" data-rawheight="214" class="origin_image zh-lightbox-thumb lazy" width="625"><p>先试验一下电台功能，完美</p><p><img src="./爬取成人视频_files/02593136477d938.jpeg" mo-width="515" mo-heigth="688" query="" data-rawwidth="515" data-rawheight="688" class="origin_image zh-lightbox-thumb lazy" width="515">再试验一下浏览指定类别</p><p><img src="./爬取成人视频_files/02593136571bedd.jpeg" mo-width="465" mo-heigth="738" query="" data-rawwidth="465" data-rawheight="738" class="origin_image zh-lightbox-thumb lazy" width="465">我们看到，一些视频的摘要被成功的返回了，但是有一些视频因为网络等因素出现了错误，根据我们的错误处理机制将traceback作为文本发送到了微信上。<br><br>接下来根据给出的视频摘要，选择一个我们中意的视频，根据ID浏览指定视频：</p><p><img src="./爬取成人视频_files/025931365766b81.jpeg" mo-width="490" mo-heigth="755" query="" data-rawwidth="490" data-rawheight="755" class="origin_image zh-lightbox-thumb lazy" width="490">完美！</p><p><b>至此，我们成功地搭建了一个私有的pornhub部分映像，并可以随时随地的开车，不，是收集鉴黄数据！</b><br><br></p><p>注：这个爬虫在设计上是多线程的，但是我用来爬取的ec2实例是单核的，所以多线程性能发挥不出来，而用本地pc访问pornhub速度又太慢。<br></p><h2><b>七、结语</b></h2><p>这个爬虫应该是我做过的最好玩的一个Python程序了，我确实是希望把它用在正途用来收集鉴黄数据。但是这样收集正样本很容易，负样本哪里去找呢？这个还需要多学习。</p><p>来不及多说了！赶快上车吧！</p><div class="highlight"><pre><code class="language-text"><span></span>git clone https://github.com/QuantumLiu/PornSpider.git
cd PornSpider
python wechat_client.py
</code></pre></div>
</body></html>